(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{360:function(e,t,a){"use strict";a.r(t);var s=a(4),v=Object(s.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"我是如何调试-webpack-问题的"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#我是如何调试-webpack-问题的"}},[e._v("#")]),e._v(" 我是如何调试 Webpack 问题的")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://mp.weixin.qq.com/s/RExi2XnpstChIPIjhhmXhw",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://mp.weixin.qq.com/s/RExi2XnpstChIPIjhhmXhw"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("事情是这样的，前两天有个小伙伴问我："),t("strong",[e._v("「为啥我的 webpack 运行完看不到我写的页面，而是：」")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmF9DetOBKop4lY1XFqXmNU0HSgfictkEBql67xODs7DVwE5wibtjD0SZw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("嗯？文件列表页？好吧，这种情况我似乎没遇到过，一下子没法给出答案，只能要来关键代码：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmlljxZma6J9EbJAoYMaUqibYvDdQ4WoJdukJiaic9SUGGNAibLuUlu598ng/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("重点看看 "),t("code",[e._v("webpack.config.js")]),e._v(" 配置，用到 "),t("code",[e._v("devServer + HMR")]),e._v(" 功能，其中：")]),e._v(" "),t("ul",[t("li",[e._v("Webpack 版本为 5.37.0")]),e._v(" "),t("li",[e._v("webpack-dev-server 版本为 3.11.2")])]),e._v(" "),t("p",[e._v("看了半天，没问题呀，给了几个纸糊的建议还是解决不了问题，刚好在开会这事就暂且放下了。过了一会，小伙伴兴冲冲跑过来跟我说经过一番盲猜，问题被解决了：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("output.publicPath = '/'")]),e._v(" 时一切正常")]),e._v(" "),t("li",[t("code",[e._v("output.publicPath = './'")]),e._v(" 时出错，返回文件列表页")])]),e._v(" "),t("p",[e._v("啊？这玩意还会影响 "),t("code",[e._v("devServer")]),e._v(" 的效果，直觉告诉我不应该啊。")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmQVcticlYRiaGPGib5pvCh7cOiaca5ibF9kUI8uXXmKA8ggGYtWcdLArHpRA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("emmm，成功勾起我的好奇心了，虽然写过一些 Webpack 源码分析的文章，但 "),t("code",[e._v("webpack-dev-server")]),e._v(" 确实不在我的知识范围，好在我有秘籍《"),t("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3OTYwMjcxMA==&mid=2247484501&idx=1&sn=0d8abed19ae67c3fade6dc44c02987db&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("如何阅读源码 —— 以 Vetur 为例"),t("OutboundLink")],1),e._v("》，是时候展示真正的技术了！")]),e._v(" "),t("h1",{attrs:{id:"第一步-定义问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第一步-定义问题"}},[e._v("#")]),e._v(" 第一步：定义问题")]),e._v(" "),t("p",[e._v("先复盘一下问题发生的过程：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("webpack.config.js")]),e._v(" 同时配置了 "),t("code",[e._v("ouput.publicPath")]),e._v(" 与 "),t("code",[e._v("devServer")])]),e._v(" "),t("li",[e._v("运行 "),t("code",[e._v("npx webpack serve")]),e._v(" 启动开发服务器")]),e._v(" "),t("li",[e._v("浏览器访问 "),t("code",[e._v("http://localhost:9000")]),e._v(" 没有按预期返回用户代码，而是返回了文件列表页面；但如果恢复 "),t("code",[e._v("output.publicPath")]),e._v(" 的默认配置，一切如常")])]),e._v(" "),t("p",[e._v("讲道理， "),t("code",[e._v("ouput.publicPath")]),e._v(" 应该只是影响了最终产物引用的路径，试试命令行工具运行 "),t("code",[e._v("curl")]),e._v(" 检测首页返回的内容：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZma5Fq6iaViaHYhxQXf7Y39tgFLkjanDo4OWGCtsFmMGnicAeQIUgD3sPLg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("blockquote",[t("p",[e._v("Tips：有时候可以试试绕过浏览器的复杂逻辑，用最简单的工具验证 http 请求返回的内容。")])]),e._v(" "),t("p",[e._v("可以看到，请求 "),t("code",[e._v("http://localhost:9000")]),e._v(" 地址返回一大串 html 代码，且页面的 title 为 "),t("code",[e._v("listing directory")]),e._v(" —— 也就是我们看到的文件列表页面：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmF9DetOBKop4lY1XFqXmNU0HSgfictkEBql67xODs7DVwE5wibtjD0SZw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("虽然不知道这是在那一层生成的，但可以肯定绝对不是我写的，而且这是在 HTTP 层面发生的。")]),e._v(" "),t("p",[e._v("所以问题的核心就是："),t("strong",[e._v("「为何 Webpack 的 "),t("code",[e._v("output.publicPath")]),e._v(" 会影响 "),t("code",[e._v("webpack-dev-server")]),e._v(" 的运行效果」")]),e._v("？")]),e._v(" "),t("h1",{attrs:{id:"第二步-回顾背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第二步-回顾背景"}},[e._v("#")]),e._v(" 第二步：回顾背景")]),e._v(" "),t("p",[e._v("带着问题我又 review 了一遍 Webpack 官方文档。")]),e._v(" "),t("h2",{attrs:{id:"publicpath配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#publicpath配置"}},[e._v("#")]),e._v(" "),t("code",[e._v("publicPath")]),e._v("配置")]),e._v(" "),t("p",[e._v("首先 "),t("code",[e._v("output.publicPath")]),e._v(" 是这么描述的：")]),e._v(" "),t("blockquote",[t("p",[e._v("❝")]),e._v(" "),t("p",[e._v("This is an important option when using on-demand-loading or loading external resources like images, files, etc. If an incorrect value is specified you'll receive 404 errors while loading these resources.")]),e._v(" "),t("p",[e._v("❞")])]),e._v(" "),t("p",[e._v("大意就是，这是一个控制按需加载或资源文件加载的选项，如果对应的路径资源加载失败时会返回 404。")]),e._v(" "),t("p",[e._v("嗐，其实这段描述就非常不明所以了，简单理解 "),t("code",[e._v("output.publicPath")]),e._v(" 会改变产物资源在 html 文件的路径，比如说 Webpack 编译完生成了 "),t("code",[e._v("bundle.js")]),e._v(" 文件，默认情况下写到 html 的路径是：")]),e._v(" "),t("div",{staticClass:"language-html extra-class"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("script")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("src")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("bundle.js"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("/>")])]),e._v("\n")])])]),t("p",[e._v("如果设置了 "),t("code",[e._v("output.publicPath")]),e._v(" 值，就会在路径前增加前缀：")]),e._v(" "),t("div",{staticClass:"language-html extra-class"},[t("pre",{pre:!0,attrs:{class:"language-html"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),e._v("script")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token attr-name"}},[e._v("src")]),t("span",{pre:!0,attrs:{class:"token attr-value"}},[t("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[e._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')]),e._v("${output.publicPath}/bundle.js"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v('"')])]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("/>")])]),e._v("\n")])])]),t("p",[e._v("看起来很简单。")]),e._v(" "),t("h2",{attrs:{id:"devserver配置项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#devserver配置项"}},[e._v("#")]),e._v(" "),t("code",[e._v("devServer")]),e._v("配置项")]),e._v(" "),t("p",[e._v("再来看看 "),t("code",[e._v("devServer")]),e._v(" 配置：")]),e._v(" "),t("blockquote",[t("p",[e._v("❝")]),e._v(" "),t("p",[e._v("This set of options is picked up by webpack-dev-server and can be used to change its behavior in various ways.")]),e._v(" "),t("p",[e._v("❞")])]),e._v(" "),t("p",[e._v("大意就是，"),t("code",[e._v("devServer")]),e._v(" 配置最终会被 "),t("code",[e._v("webpack-dev-server")]),e._v(" 消费，而"),t("code",[e._v("webpack-dev-server")]),e._v(" 提供了包括 HMR —— 模块热更新在内的 web 服务。")]),e._v(" "),t("p",[e._v("感受一下，包括"),t("code",[e._v("vue-cli、create-react-app")]),e._v("之类的脚手架工具底层都依赖于"),t("code",[e._v("webpack-dev-server")]),e._v("，它的作用和重要性就可想而知了吧。")]),e._v(" "),t("h1",{attrs:{id:"第三步-分析问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第三步-分析问题"}},[e._v("#")]),e._v(" 第三步：分析问题")]),e._v(" "),t("p",[e._v("按照现有的情报，加上我对 HTTP 协议的理解，可以基本推断问题必然是出在"),t("code",[e._v("webpack-dev-server")]),e._v(" 框架处理首页请求的逻辑上，大概率是 "),t("code",[e._v("output.publicPath")]),e._v(" 属性影响到首页资源的判定逻辑，导致 `webpack-dev-server 找不到对应的资源文件，返回兜底的文件列表页面。")]),e._v(" "),t("p",[e._v("嗯，我觉得靠谱，那就沿着这个思路挖一挖源码，找到具体原因吧。")]),e._v(" "),t("h1",{attrs:{id:"第四步-分析代码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第四步-分析代码"}},[e._v("#")]),e._v(" 第四步：分析代码")]),e._v(" "),t("h2",{attrs:{id:"结构分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结构分析"}},[e._v("#")]),e._v(" 结构分析")]),e._v(" "),t("p",[e._v("书上得来终须浅，debug 还需看源码啊，啥都别说了先打开"),t("code",[e._v("webpack-dev-server")]),e._v(" 包的代码看看内容吧：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmeyic4bnLJpEnchPjBoaloibA3p20gX1jA8Qib482KY9yq1awM0R5ic70aA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("blockquote",[t("p",[e._v("Tips: 读者也可以试试 clone webpack-dev-server 仓库的代码，有惊喜~~")])]),e._v(" "),t("p",[e._v("项目结构并不复杂，按 Webpack 的习惯可以推断主要代码都在 "),t("code",[e._v("lib")]),e._v(" 目录：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZm64QoibE1OHK5Chc3XWYSONKiajaQEqvUjnVAqJTAYmVb19Scib6Off7bA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("blockquote",[t("p",[t("code",[e._v("cloc")]),e._v(" 是一个非常好用的代码统计工具，官网：https://www.npmjs.com/package/cloc")])]),e._v(" "),t("p",[e._v("代码量也就 2000 出头，还好还好。")]),e._v(" "),t("p",[e._v("接下来再打开 "),t("code",[e._v("package.json")]),e._v(" 文件，看看有哪些 "),t("code",[e._v("dependency")]),e._v("，一个个捋过去之后，与我们的问题强相关的依赖有：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("express")]),e._v("：应用不用多介绍了吧")]),e._v(" "),t("li",[t("code",[e._v("webpack-dev-middleware")]),e._v("：这个应该大多数人没有注意过，从官网文档判断这是一个桥接"),t("code",[e._v("Webpack")]),e._v("编译过程与"),t("code",[e._v("express")]),e._v("的中间件")]),e._v(" "),t("li",[t("code",[e._v("serve-index")]),e._v("："),t("strong",[e._v("「提供特定目录下文件列表页面的 express 中间件」")]),e._v("！！！")])]),e._v(" "),t("p",[e._v("按照这个描述，这锅肯定出在 "),t("code",[e._v("serve-index")]),e._v(" 的调用上啊，感觉离答案很近了。")]),e._v(" "),t("h2",{attrs:{id:"局部分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#局部分析"}},[e._v("#")]),e._v(" 局部分析")]),e._v(" "),t("h3",{attrs:{id:"切入点-验证-serve-index-包的作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#切入点-验证-serve-index-包的作用"}},[e._v("#")]),e._v(" 切入点：验证 "),t("code",[e._v("serve-index")]),e._v(" 包的作用")]),e._v(" "),t("p",[e._v("经过上面的分析，虽然我还不知道问题具体出在哪里，但大致可以判定跟 "),t("code",[e._v("serve-index")]),e._v(" 包强相关，先搜一下 webpack-dev-server 在哪些地方引用这个包：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmps7ic3hHkhZbJxhYhL9sNuKxFEZ1sZLa1eJiclDPl3B5KniaRsFBLRnpQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("很幸运，只在 "),t("code",[e._v("lib/Server.js")]),e._v(" 文件中用到，那就简单多了，**「静态分析」**调用语句前后的语句，大致上可以推导出：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("serveIndex")]),e._v(" 调用被包裹在 "),t("code",[e._v("this.app.use")]),e._v(" 内，推测 "),t("code",[e._v("this.app")]),e._v(" 指向 express 示例，"),t("code",[e._v("use")]),e._v(" 函数用于注册中间件，所以整个 "),t("code",[e._v("serveIndex")]),e._v(" 就是一个中间件")]),e._v(" "),t("li",[e._v("除 "),t("code",[e._v("setupStaticServeIndexFeature")]),e._v(" 外，"),t("code",[e._v("Server")]),e._v(" 类型中还包含了其它命名为 "),t("code",[e._v("setupXXXFeature")]),e._v(" 的函数，基本上都用于添加 express 中间件，这些中间件组合拼装出"),t("code",[e._v("webpack-dev-server")]),e._v(" 提供的 "),t("code",[e._v("HMR、proxy、ssl")]),e._v(" 等功能")])]),e._v(" "),t("p",[e._v("也看不出别的啥了，先做个对照实验，运行起来**「动态分析」**代码的实际执行过程，验证到底是不是这个地方出错吧。先在 "),t("code",[e._v("serveIndex")]),e._v(" 函数之前插入 "),t("code",[e._v("debugger")]),e._v(" 语句，之后：")]),e._v(" "),t("ul",[t("li",[e._v("先按照正常情况，也就是 "),t("code",[e._v("output.publicPath = '/'")]),e._v(" 执行 "),t("code",[e._v("ndb npx webpack serve")]),e._v("，结果是如常打开了页面，没有命中断点，没有中断")]),e._v(" "),t("li",[e._v("再按照 "),t("code",[e._v("ouput.publicPath = './'")]),e._v(" 执行 "),t("code",[e._v("ndb npx webpack serve")]),e._v("，进入断点：")])]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmSVFxCFEH1KEAG4TMuLfdTsriaGMaUdTRrrBlXmx9LuRz8jUXCU5vicyA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("blockquote",[t("p",[e._v("Tips： ndb 是一个开箱即用的 node debugger 工具，不需要做任何配置就能调试 node 应用，非常方便")])]),e._v(" "),t("p",[e._v("OK，答案揭晓了，在 "),t("code",[e._v("ouput.publicPath = './'")]),e._v(" 场景下会命中这个中间件，执行 "),t("code",[e._v("serveIndex")]),e._v(" 函数返回文件目录列表，这很 "),t("code",[e._v("make sense")]),e._v("。")]),e._v(" "),t("p",[e._v("不过，作为一个有追求的程序员怎么会止步于此呢，我们继续往下挖呀：到底是那一段代码决定了流程会不会进入 "),t("code",[e._v("serveIndex")]),e._v(" 中间件？")]),e._v(" "),t("h3",{attrs:{id:"切入点-确定-serveindex-的上游中间件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#切入点-确定-serveindex-的上游中间件"}},[e._v("#")]),e._v(" 切入点：确定 "),t("code",[e._v("serveIndex")]),e._v(" 的上游中间件")]),e._v(" "),t("p",[e._v("思考一下，"),t("code",[e._v("express")]),e._v(" 架构的特点就是 —— 基于中间件的洋葱模型，而中间件之间通过 "),t("code",[e._v("next")]),e._v(" 函数调起下一个中间件。")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmISM18D5SsrRXwzlh7QdIcOFuMibgUzAnSVwTTibSYAAtN6kSuPRdbBwQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("嗯，有思路了，我们沿着 "),t("code",[e._v("webpack-dev-server")]),e._v("的 "),t("code",[e._v("middleware")]),e._v(" 队列，找到 "),t("code",[e._v("serveIndex")]),e._v(" 之前都有哪些中间件，分析这些中间件的代码应该就能解答：")]),e._v(" "),t("blockquote",[t("p",[e._v("到底是那一段代码决定了流程会不会进入 "),t("code",[e._v("serveIndex")]),e._v(" 中间件？")])]),e._v(" "),t("p",[e._v("但是，express 中间件架构下，从 "),t("code",[e._v("next")]),e._v(" 调用到实际中间件函数隔着很远的调用链路，很难通过断点的调用堆栈判断出上一级中间件，以及更更上一级中间件在哪里啊：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_gif/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmicGZUO8WJCCdV1ZZ2kHsgjhRPg4Yic6H9Wg2pz38v3Vhx7fsG0BWiabaw/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("这时候不能硬刚，得换一个技巧了 —— 找到创建 express 示例的代码，用魔法包裹住 "),t("code",[e._v("use")]),e._v("函数：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZma7JURLF9C2YCe0JIsYb1Z0R0CATPicQbJ2qw7gpWeTKAq2OtiadEyTHA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("blockquote",[t("p",[e._v("Tips: 这种技巧在某些复杂场景下特别有用，比如我在学习 Webpack 源码的时候，就经常配合 "),t("code",[e._v("Proxy")]),e._v(" 类对 hook 植入 debugger 语句，追踪钩子被谁监听，在哪里被触发")])]),e._v(" "),t("p",[e._v("通过这种重写函数，植入断点的方式，我们就能轻松追溯到"),t("code",[e._v("webpack-dev-server")]),e._v(" 用到了哪些中间件，以及中间件注册的顺序：")]),e._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("setupCompressFeature")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" 注册资源压缩中间件\n"),t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("setupMiddleware")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" 注册 webpack"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("dev"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("middleware 中间件\n"),t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("setupStaticFeature")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" 注册静态资源服务中间件\n"),t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("setupServeIndexFeature")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" 注册 serveIndex 中间件\n")])])]),t("p",[e._v("可以看到，在当前 Webpack 配置下总共注册了这四个中间件函数，按照 express 的执行逻辑这四个中间件会按注册顺序从上往下执行，所以 "),t("code",[e._v("serveIndex")]),e._v(" 函数的直接上游就是 "),t("code",[e._v("setupStaticFeature")]),e._v(" 注册的静态资源服务中间件了。")]),e._v(" "),t("p",[e._v("继续看看 "),t("code",[e._v("setupStaticFeature")]),e._v(" 函数的代码：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmXgPJGnbVQ8cUiaeWAyqkgmgXiaJW5ibx3ejbIaZzN8qKUUChCchX9nHVQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("这里只是调用标准化的 "),t("code",[e._v("[express.static](https://expressjs.com/en/starter/static-files.html)")]),e._v(" 函数，注入静态资源服务功能，如果这个中间件运行的时候按路径找不到对应的文件资源，会调用下一个中间件继续处理请求，看起来跟我们的问题没啥关系。")]),e._v(" "),t("p",[e._v("继续往上，看看 "),t("code",[e._v("setupMiddleware")]),e._v(" 函数：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmGpa2YecorheTDOzgfkzXAm5hAVqaUYq89YIr7qu5sL7yvnWtEzG7yA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("注册了 "),t("code",[e._v("webpack-dev-middleware")]),e._v("，从名字就可以看出这个中间件跟 "),t("code",[e._v("webpack-dev-server")]),e._v(" 应该关系匪浅，那就继续打开 "),t("code",[e._v("webpack-dev-middleware")]),e._v(" 看看里面的代码：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmJ9rRz48mel8TzMlIXq3u8Uns6kQ83hoYOSxZZFGjaEibSQWbOzBlvKQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("我去。。。也不少啊，这看起来太费劲了，我只是想找到这个 bug 的原因，没必要全看吧！那就直接搜关键词 "),t("code",[e._v("publicPath")]),e._v(" 试试吧：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmJ9rRz48mel8TzMlIXq3u8Uns6kQ83hoYOSxZZFGjaEibSQWbOzBlvKQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("比较幸运，"),t("code",[e._v("publicPath")]),e._v(" 关键字出现的频率还是比较少的：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("webpack-dev-middleware/lib/middleware.js")]),e._v(" 文件中被使用了 1 次")]),e._v(" "),t("li",[t("code",[e._v("webpack-dev-middleware/lib/util.js")]),e._v(" 文件中被使用了 23 次")])]),e._v(" "),t("p",[e._v("那，就先挑软柿子捏，看看 "),t("code",[e._v("middleware.js")]),e._v(" 文件中是怎么用的：")]),e._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" getFilenameFromUrl "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./util'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\nmodule"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("exports")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("wrapper")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("context")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("middleware")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" res"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" next")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("goNext")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("resolve")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("next")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("let")]),e._v(" filename "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("getFilenameFromUrl")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n      context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("options"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("publicPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n      context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compiler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n      req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("url\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("filename "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("===")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("goNext")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Promise")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("resolve")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("handleRequest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" filename"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" processRequest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" req"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// ...")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),t("p",[e._v("注意代码中有一个逻辑，就是调用 "),t("code",[e._v("util")]),e._v(" 文件的 "),t("code",[e._v("getFilenameFromUrl")]),e._v(" 函数，并判断返回的 "),t("code",[e._v("filename")]),e._v(" 值是否为 "),t("code",[e._v("false")]),e._v("，是的话调用 "),t("code",[e._v("next")]),e._v(" 函数，这看起来很像那么回事了！")]),e._v(" "),t("p",[e._v("那就继续进去看看 "),t("code",[e._v("getFilenameFromUrl")]),e._v(" 的代码：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZm8A6qgic5JJeR4tHtvo20EkWhScM6EDO8LYv2pWC4RpmfibysgZCzmpQA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("逐行分析下来，注意看红框框出来这一句：")]),e._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("xxx "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" url"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("indexOf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("publicPath"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!==")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),t("p",[e._v("讲道理，从字面意义上这个 "),t("code",[e._v("url")]),e._v(" 应该是客户端发过来的请求连接，"),t("code",[e._v("publicPath")]),e._v(" 应该就是我们在 "),t("code",[e._v("webpack.config.js")]),e._v(" 中配置的 "),t("code",[e._v("output.publicPath")]),e._v(" 项的值了吧？运行起来看看：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmHOebocwSjYhPf02fSbl0zuiciaD9thfmq0JVF0xwu1ic6L3sYBhX34m7A/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("果然，断点进去之后可以看到这两个值确确实实符合前面的猜想，问题就出在这里，此时：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("url = '/")]),e._v("'`")]),e._v(" "),t("li",[t("code",[e._v("publicPath = output.publicPath = '/helloworld'")])]),e._v(" "),t("li",[e._v("所以 "),t("code",[e._v("url.indexOf(publicPath) === false")]),e._v(" 实锤")])]),e._v(" "),t("p",[t("code",[e._v("getFilenameFromUrl")]),e._v(" 函数执行结果为 "),t("code",[e._v("false")]),e._v("，所以 "),t("code",[e._v("webpack-dev-middleware")]),e._v(" 会直接调用 "),t("code",[e._v("next")]),e._v(" 方法进入下一个中间件。")]),e._v(" "),t("p",[e._v("如果手动在默认打开的路径后加上 "),t("code",[e._v("output.publicPath")]),e._v(" 的内容：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblkv8oY68bkOJ8qHRDCeJBZmTYZqIic9YiaRCuict4XO5r5iboibSGnk2XIhbQfdZXdR1pKw3Ucicu6nAl4g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("果然，它又行了。")]),e._v(" "),t("h1",{attrs:{id:"第五步-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第五步-总结"}},[e._v("#")]),e._v(" 第五步：总结")]),e._v(" "),t("p",[e._v("嗐，你看，这就是源码分析的过程，繁琐但不复杂，简直人人都能成为技术大牛啊。回顾一下代码的流程：")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("webpack-dev-server")]),e._v(" 启动后会调用自动打开浏览器访问默认路径 "),t("code",[e._v("http://localhost:9000")])]),e._v(" "),t("li",[e._v("此时 "),t("code",[e._v("webpack-dev-server")]),e._v(" 接收到默认路径请求，沿着 express 逻辑逐步走到 "),t("code",[e._v("webpack-dev-middleware")]),e._v(" 中间件中")]),e._v(" "),t("li",[t("code",[e._v("webpack-dev-middleware")]),e._v(" 中间件内部呢，又继续调用 "),t("code",[e._v("webpack-dev-middleware/lib/util.js")]),e._v(" 文件的 "),t("code",[e._v("getFilenameFromUrl")]),e._v(" 方法")]),e._v(" "),t("li",[t("code",[e._v("getFilenameFromUrl")]),e._v(" 内部判断 "),t("code",[e._v("url.indexOf(publicPath)")])]),e._v(" "),t("li",[e._v("若 "),t("code",[e._v("getFilenameFromUrl")]),e._v(" 返回 "),t("code",[e._v("false")]),e._v(" 则 "),t("code",[e._v("webpack-dev-middleware")]),e._v(" 直接调用 "),t("code",[e._v("next")]),e._v(" ，流程进入下一个中间件 "),t("code",[e._v("express.static")])]),e._v(" "),t("li",[t("code",[e._v("express.static")]),e._v(" 尝试读取 "),t("code",[e._v("http://localhost:9000")]),e._v(" 对应的资源文件，发现文件不存在，流程继续进入最后一个中间件 "),t("code",[e._v("serveIndex")])]),e._v(" "),t("li",[t("code",[e._v("serveIndex")]),e._v(" 返回产物目录结构界面，不符合开发者预期")])]),e._v(" "),t("p",[e._v("归根结底，这里面的问题：")]),e._v(" "),t("ol",[t("li",[e._v("Webpack 官网关于 "),t("code",[e._v("output.publicPath")]),e._v(" 的介绍只说了会影响 bundle 产物路径，没说会影响主页面的索引路径，开发者表示很 confuse 咯")]),e._v(" "),t("li",[t("code",[e._v("webpack-dev-server")]),e._v(" 启动后，自动打开页面时没有在链接后面自动追加 "),t("code",[e._v("output.publicPath")]),e._v(" 值导致默认打开的路径与真正的 index 首页不一致，而且还没返回 "),t("strong",[e._v("「404」")]),e._v(" 一类通用的错误提示，取而代之以一个不明所以的**「文件列表页」**，开发者很难迅速 get 到问题到底出在哪")])]),e._v(" "),t("p",[e._v("到这里就把问题从表象，到原理，到最最根本的问题所在都挖出来了，以后可以跟其他同学说：")]),e._v(" "),t("blockquote",[t("p",[e._v("开发阶段，尽量避免配置 "),t("code",[e._v("output.publicPath")]),e._v(" 项，否则会有惊喜哦~~")])])])}),[],!1,null,null,null);t.default=v.exports}}]);