(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{354:function(e,s,t){"use strict";t.r(s);var n=t(4),o=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"十分钟精进-webpack-module-issuer-属性详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#十分钟精进-webpack-module-issuer-属性详解"}},[e._v("#")]),e._v(" 十分钟精进 Webpack："),s("code",[e._v("module.issuer")]),e._v(" 属性详解")]),e._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://mp.weixin.qq.com/s/QkXFOHNpL0PRQtCcWIaX-g",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://mp.weixin.qq.com/s/QkXFOHNpL0PRQtCcWIaX-g"),s("OutboundLink")],1)])]),e._v(" "),s("p",[e._v("本文讲解 webpack 的 "),s("code",[e._v("module.issuer")]),e._v(" 属性，内容涵盖该属性的作用、运行原理，并结合 webpack 实例讲解应用场景。")]),e._v(" "),s("h1",{attrs:{id:"module-issuer-是什么"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#module-issuer-是什么"}},[e._v("#")]),e._v(" "),s("code",[e._v("module.issuer")]),e._v(" 是什么")]),e._v(" "),s("p",[e._v("在 webpack 实现上，文件资源使用 "),s("code",[e._v("Module")]),e._v(" 类管理，所有关于资源的操作、转译、合并、关系都在 "),s("code",[e._v("module")]),e._v(" 实现。而 "),s("code",[e._v("module.issuer")]),e._v(" 属性用于记录资源的引用者，例如对于下面的资源依赖：")]),e._v(" "),s("p",[s("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/3xDuJ3eiciblmhRW1n9ZTjImPbJ2Ric2bAISpcS7ibG70aoRRicH6SJAmnh7ibDZgxqoEBhcjjD8lmhd4W3ajB7ClCWA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),s("p",[s("code",[e._v("index")]),e._v(" 引用了 "),s("code",[e._v("a/b")]),e._v(" 两个文件，webpack 构建时会用三个 "),s("code",[e._v("module")]),e._v(" 对象分别对应三个文件，同时在 "),s("code",[e._v("a/b")]),e._v(" 模块中通过 "),s("code",[e._v("issuer")]),e._v(" 属性指向 "),s("code",[e._v("index")]),e._v(" 模块：")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("module['a.js'].issuer = module['index.js']")])]),e._v(" "),s("li",[s("code",[e._v("module['b.js'].issuer = module['index.js']")])])]),e._v(" "),s("p",[e._v("通过 "),s("code",[e._v("issuer")]),e._v(" 属性，模块可以反向查找到引用者。")]),e._v(" "),s("h1",{attrs:{id:"实例-stats-类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实例-stats-类"}},[e._v("#")]),e._v(" 实例：Stats 类")]),e._v(" "),s("p",[s("code",[e._v("Stats")]),e._v(" 是 webpack 内置的对象，用于收集构建过程信息，比如耗时、模块依赖关系、错误信息、报警信息等，我们运行 webpack 命令输出的命令行信息就是由 "),s("code",[e._v("Stats")]),e._v(" 类提供的：")]),e._v(" "),s("p",[s("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),s("p",[e._v("如果编译过程发生错误，"),s("code",[e._v("Stats")]),e._v(" 会通过 "),s("code",[e._v("module.issuer")]),e._v(" 属性逐级往上查找出完整调用堆栈：")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("class Stats {\n  constructor(compilation) {\n    // ...\n  }\n  toJson(options, forToString) {\n    const formatError = (e) => {\n      // ...\n      if (showModuleTrace && e.origin) {\n        text += `\\n @ ${this.formatFilePath(\n          e.origin.readableIdentifier(requestShortener)\n        )}`;\n        // ...\n        while (current.issuer) {\n          current = current.issuer;\n          text += `\\n @ ${current.readableIdentifier(requestShortener)}`;\n        }\n      }\n      return text;\n    };\n  }\n}\n")])])]),s("p",[e._v("最终输出下图最后两行错误堆栈：")]),e._v(" "),s("p",[s("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),s("h1",{attrs:{id:"源码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#源码"}},[e._v("#")]),e._v(" 源码")]),e._v(" "),s("p",[e._v("issuer 属性定义在 "),s("code",[e._v("webpack/lib/Module.js")]),e._v(" 的 "),s("code",[e._v("construct")]),e._v(" 函数，但 webpack 中使用较少，难以追踪，这里取了个巧，用 "),s("code",[e._v("Object.defineProperty")]),e._v(" 拦截 "),s("code",[e._v("issuer")]),e._v("属性，定位出哪里获取/修改了这个属性：")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('// webpack/lib/Module.js\nclass Module extends DependenciesBlock {\n  constructor(type, context = null) {\n    // ...\n    // 注释掉原本的定义\n    // this.issuer = null;\n    // 用 Object.defineProperty 拦截\n    this._issuer=null;\n    Object.defineProperty(this, "issuer", {\n        get: () => {\n            debugger;\n            return this._issuer;\n        },\n        set: (value) => {\n            debugger;\n            this._issuer = value;\n        },\n    });\n    // ...\n  }\n}\n')])])]),s("p",[e._v("之后，使用 "),s("code",[e._v("ndb")]),e._v(" 断点追踪 "),s("code",[e._v("issuer")]),e._v(" 的使用情况，可以看到只有在 "),s("code",[e._v("compilation")]),e._v(" 对象的 "),s("code",[e._v("addModuleDependencies")]),e._v(" 函数中触发 "),s("code",[e._v("set")]),e._v(" 函数：")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("class Compilation {\n  addModuleDependencies(\n    module,\n    dependencies,\n    bail,\n    cacheGroup,\n    recursive,\n    callback\n  ) {\n    // ...\n    if (addModuleResult.issuer) {\n      if (currentProfile) {\n        dependentModule.profile = currentProfile;\n      }\n      // 触发更改\n      dependentModule.issuer = module;\n    }\n    // ...\n  }\n}\n")])])]),s("p",[s("code",[e._v("addModuleDependencies")]),e._v(" 函数的作用是为已有 "),s("code",[e._v("module")]),e._v(" 添加依赖声明，例如对于上面的例子：")]),e._v(" "),s("p",[s("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),s("p",[e._v("在 "),s("code",[e._v("compilation")]),e._v(" 解析(解析过程可参考：[万字总结] 一文吃透 Webpack 核心原理)出 "),s("code",[e._v("index.js")]),e._v(" 内容的 AST 后，遍历 "),s("code",[e._v("require/import")]),e._v(" 语句解读当前模块引用了那些资源，解析到任意依赖后就会调用 "),s("code",[e._v("addModuleDependencies")]),e._v(" 记录依赖关系，从 "),s("code",[e._v("addModuleDependencies")]),e._v(" 源码看在依赖被创建为 "),s("code",[e._v("module")]),e._v(" 时，会同步修改新模块的 "),s("code",[e._v("issuer")]),e._v(" ，记录引用者的信息。")]),e._v(" "),s("h1",{attrs:{id:"示例-追溯模块引用关系"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例-追溯模块引用关系"}},[e._v("#")]),e._v(" 示例：追溯模块引用关系")]),e._v(" "),s("p",[e._v("基于 "),s("code",[e._v("module.issuer")]),e._v(" ，我们可以从特定 "),s("code",[e._v("module")]),e._v(" 出发反向遍历依赖关系链，为此我写了个示例插件：")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('function RevertTracePlugin(options) {\n}\n\nRevertTracePlugin.prototype.apply = function(compiler) {\n  // compilation 被创建出来后触发\n  compiler.hooks.thisCompilation.tap("RevertTracePlugin", function(compilation) {\n    // 构建模块前触发\n    compilation.hooks.buildModule.tap("RevertTracePlugin", (module) => {\n      const stack = [];\n      let current = module;\n      // 向上遍历，找出所有引用者\n      while (current.issuer) {\n        stack.push(current.issuer.rawRequest);\n        current = current.issuer;\n      }\n      if (stack.length > 0) {\n        console.group(`资源 ${module.rawRequest} 引用链： `);\n        console.log(stack.join("\\n"));\n        console.groupEnd();\n        console.log();\n      }\n    });\n  });\n};\n')])])]),s("p",[e._v("上述插件用到两个钩子：")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("compiler.hooks.thisCompilation")]),e._v("：webpack 启动编译，创建出 "),s("code",[e._v("compilation")]),e._v(" 对象时触发，在示例场景中作为中间步骤，用于获取创建出的 "),s("code",[e._v("compilation")]),e._v(" 对象")]),e._v(" "),s("li",[s("code",[e._v("compilation.hooks.buildModule")]),e._v(" ：执行模块构建之前触发，此时 "),s("code",[e._v("module")]),e._v(" 对象所有原信息都初始化完毕，可以正常获取到 "),s("code",[e._v("issuer")]),e._v(" 属性")])]),e._v(" "),s("blockquote",[s("p",[e._v("❝")]),e._v(" "),s("p",[e._v("关于 webpack 钩子的更多内容，可查阅往前文章：[源码解读] Webpack 插件架构深度讲解")]),e._v(" "),s("p",[e._v("❞")])]),e._v(" "),s("p",[e._v("在 "),s("code",[e._v("buildModule")]),e._v(" 钩子内部通过 "),s("code",[e._v("while")]),e._v(" 循环不断向上遍历，最终可追溯到完整引用链条，例如对于下图的文件依赖关系：")]),e._v(" "),s("p",[s("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),s("p",[e._v("入口 "),s("code",[e._v("index.js")]),e._v(" 文件引用了 "),s("code",[e._v("a.js")]),e._v("，"),s("code",[e._v("a.js")]),e._v(" 文件引用了 "),s("code",[e._v("b.js")]),e._v("，上述插件运行效果：")]),e._v(" "),s("p",[s("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),s("h1",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),s("p",[s("code",[e._v("module.issuer")]),e._v(" 属性在 webpack 中使用的比较少，因为大多数时候模块间的依赖关系都可以通过 dependency graph 相关的属性正向获取，下一期我们就来聊聊 dependency graph 相关内容，感兴趣的同学欢迎点赞关注。")])])}),[],!1,null,null,null);s.default=o.exports}}]);